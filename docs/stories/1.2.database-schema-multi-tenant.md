# Story 1.2: Database Schema & Multi-Tenant Architecture

## Status

In Progress

## Story

**As a** system architect,
**I want** a properly designed database schema with multi-tenant support and row-level security,
**so that** each clinic's data is completely isolated and secure from other organizations.

## Acceptance Criteria

1. PostgreSQL database with proper schema design for multi-tenancy
2. Row-level security policies enforcing data isolation between organizations
3. Drizzle ORM setup with type-safe migrations and database interactions
4. Organization model with tenant isolation at the database level
5. Audit logging framework for tracking data access and modifications
6. Backup and recovery procedures documentation

## Tasks / Subtasks

- [x] Drizzle ORM setup & migrations (AC: 3)
  - [x] Add Drizzle dependencies and configure migration scripts (AC: 3)
  - [x] Define typed schema models for core tables (AC: 3)
  - [x] Implement initial migration including RLS enablement (AC: 3)

- [x] PostgreSQL schema for multi-tenancy (AC: 1)
  - [x] Define core tables: organizations, users, patients, appointments with org_id (AC: 1)
  - [x] Add indexes for org_id and common query patterns (AC: 1)
  - [ ] Document schema decisions and org scoping strategy (AC: 6)

- [x] Row-level security policies (AC: 2)
  - [x] Enable RLS on tenant-scoped tables (AC: 2)
  - [x] Create policies filtering by `org_id` from session context (AC: 2)
  - [ ] Verify access isolation with test queries (AC: 2)

- [x] Organization model with tenant isolation (AC: 4)
  - [x] Create `organizations` table and relationships (AC: 4)
  - [x] Add helper functions to inject org context at query time (AC: 4)
  - [ ] Document org-scoped data access patterns (AC: 6)

- [x] Audit logging framework (AC: 5)
  - [x] Add audit trail table for CRUD events with actor, org, timestamp (AC: 5)
  - [ ] Implement triggers or application-layer logging (AC: 5)
  - [ ] Document audit retention and access policies (AC: 6)

- [ ] Backup & recovery documentation (AC: 6)
  - [ ] Define backup cadence and storage (AC: 6)
  - [ ] Document restore procedures and verification steps (AC: 6)
  - [ ] Link procedures into deployment checklist (AC: 6)

## Dev Notes

- Recommended stack alignment:
  - Database: PostgreSQL 15+; ORM: Drizzle ORM; noted in tech stack evaluation — see <mcfile name="technology-stack-evaluation.md" path="/Users/adil/Dev/01-Projects/02-kine/web-app/docs/architecture/technology-stack-evaluation.md"></mcfile>
- Performance considerations:
  - Indexing strategies and connection pooling patterns are documented — see <mcfile name="performance-scalability-strategy.md" path="/Users/adil/Dev/01-Projects/02-kine/web-app/docs/architecture/performance-scalability-strategy.md"></mcfile>
- Testing expectations:
  - Integration tests should validate org isolation on API endpoints — see <mcfile name="testing-strategy.md" path="/Users/adil/Dev/01-Projects/02-kine/web-app/docs/implementation-guide/testing-strategy.md"></mcfile>

### Testing

- Unit tests: Models and helper functions for org context
- Integration tests: Database policies enforcing isolation; API routes should only return data for current org

## Change Log

| Date       | Version | Description                                                      | Author |
| ---------- | ------- | ---------------------------------------------------------------- | ------ |
| 2025-10-07 | 0.2     | Marked completed DB and RLS tasks; added audit table and scripts | Dev    |

## Dev Agent Record

- Agent Model Used: Trae AI
- Debug Log References: Drizzle setup, RLS policies, org context helper
- Completion Notes List:
  - Installed `drizzle-orm`, `drizzle-kit`, `postgres`
  - Added `drizzle.config.ts` and initial migration
  - Implemented tables for organizations, users, patients, appointments
  - Enabled RLS and added policies using session parameter
  - Added `server/lib/db.ts` and `server/lib/orgContext.ts`
  - Updated `.env.example` with `DATABASE_URL`
  - Added `audit_logs` table and migration; added package scripts for drizzle
- File List:
  - <mcfile name="drizzle.config.ts" path="/Users/adil/Dev/01-Projects/02-kine/web-app/drizzle.config.ts"></mcfile>
  - <mcfile name="db.ts" path="/Users/adil/Dev/01-Projects/02-kine/web-app/server/lib/db.ts"></mcfile>
  - <mcfile name="orgContext.ts" path="/Users/adil/Dev/01-Projects/02-kine/web-app/server/lib/orgContext.ts"></mcfile>
  - <mcfile name="auth.ts" path="/Users/adil/Dev/01-Projects/02-kine/web-app/server/database/schema/auth.ts"></mcfile>
  - <mcfile name="patients.ts" path="/Users/adil/Dev/01-Projects/02-kine/web-app/server/database/schema/patients.ts"></mcfile>
  - <mcfile name="appointments.ts" path="/Users/adil/Dev/01-Projects/02-kine/web-app/server/database/schema/appointments.ts"></mcfile>
  - <mcfile name="index.ts" path="/Users/adil/Dev/01-Projects/02-kine/web-app/server/database/schema/index.ts"></mcfile>
  - <mcfile name="0001_initial.sql" path="/Users/adil/Dev/01-Projects/02-kine/web-app/server/database/migrations/0001_initial.sql"></mcfile>
  - <mcfile name="0002_audit.sql" path="/Users/adil/Dev/01-Projects/02-kine/web-app/server/database/migrations/0002_audit.sql"></mcfile>

## QA Results

- Outcome: Typecheck and lint passed
- Notes: Remaining documentation tasks and audit logging triggers are pending
